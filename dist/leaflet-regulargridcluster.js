L.RegularGridClusterCell=L.Polygon.extend({options:{color:"white",weight:1,fillOpacity:.6},initialize:function(t,e){this.options=L.extend(this.options,e),L.Util.setOptions(this,e),L.Polygon.prototype.initialize.call(this,t,e)}}),L.regularGridClusterCell=function(t){return new L.RegularGridClusterCell(t)},L.RegularGridClusterClusterGroup=L.FeatureGroup.extend({options:{},initialize:function(t){this.controller=t.controller,this.options=L.extend(this.options,t),L.Util.setOptions(this,t),L.FeatureGroup.prototype.initialize.call(this,{features:[]},t)},addLayer:function(t){L.FeatureGroup.prototype.addLayer.call(this,t)},truncate:function(){this.clearLayers()}}),L.regularGridClusterClusterGroup=function(t){return new L.RegularGridClusterClusterGroup(t)},L.RegularGridClusterClusterMarker=L.Marker.extend({options:{},initialize:function(t){this.options=L.extend(this.options,t),L.Util.setOptions(this,t),L.Marker.prototype.initialize.call(this,{features:[]},t)}}),L.regularGridClusterClusterMarker=function(t){return new L.RegularGridClusterClusterMarker(t)},L.RegularGridClusterGrid=L.FeatureGroup.extend({options:{fillScale:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"]},initialize:function(t){this.controller=t.controller,this.cellid=0,this.options=L.extend(this.options,t),this.cells=[],L.Util.setOptions(this,t),L.FeatureGroup.prototype.initialize.call(this,{features:[]},t)},render:function(t,e){this.visualiseCells()},addLayer:function(t){L.FeatureGroup.prototype.addLayer.call(this,t),t.inside=this.controller.countInside(t)},createCell:function(t,e){var i=new L.regularGridClusterCell(t,e);return i.cellId=this.cellid,this.addLayer(i),this.cellid++,i},addValueToCell:function(t,e,i){t.options[e]=i},visualiseCells:function(){var t=this.getCells(),e=this.maxInside(t)+1,i=this.options.fillScale.length,r=e/i;for(var n in t){var s=t[n],l=this.options.fillScale[Math.floor(s.inside/r)];s.setStyle({fillColor:l})}},maxInside:function(t){return Math.max.apply(Math,t.map(function(t){return t.inside}))},getCells:function(){return this.getLayers()},truncate:function(){this.clearLayers()}}),L.regularGridClusterGrid=function(t){return new L.RegularGridClusterGrid(t)},L.RegularGridCluster=L.FeatureGroup.extend({options:{gridBoundsPadding:.1,gridMode:"square",cellSize:1e4},initialize:function(t){this.options=L.extend(this.options,t),L.Util.setOptions(this,t),this.elements=[],this._grid=new L.regularGridClusterGrid({controller:this}),this._clusters=new L.regularGridClusterClusterGroup({controller:this}),L.FeatureGroup.prototype.initialize.call(this,{features:[]},t)},onAdd:function(t){var e=this;this._map=t,this._grid.addTo(this._map),this._clusters.addTo(this._map),this._map.on("zoomend",function(){e.refresh(!0,!0)}),this.refresh(!0,!0)},addLayer:function(t){L.FeatureGroup.prototype.addLayer.call(this,t),this._map&&this.refresh(!0,!0)},refresh:function(t,e){console.log("refresh"),t&&this._buildGrid(),e&&this._buildClusters()},_buildGrid:function(){this._truncateGrid(),this._prepareCells(),this._grid.addTo(this._map),this._grid.render(this._cellSize(),this.gridOrigin())},_buildClusters:function(){this._truncateClusters()},_prepareCells:function(){for(var t=this._cellSize(),e=this.gridOrigin(),i=this.gridExtent().getNorthEast(),r=i.lng,n=i.lat,s=e.lng,l=e.lat,o=t/111319;l<n;){for(var u=this._cellHeightAtY(l,t);s<r;){var a=this._createPath(s,l,u,o);this._createCell(a,{});s+=o}s=e.lng,l+=u}},_createPath:function(t,e,i,r){switch(this.options.gridMode){case"square":return[[e,t],[e,t+r],[e+i,t+r],[e+i,t],[e,t]];default:return[[e,t],[e,t+r],[e+i,t+r],[e+i,t],[e,t]]}},countInside:function(t){switch(this.options.gridMode){case"square":return this._countInsideSquare(t);default:return this._countInsideSquare(t)}},_countInsideSquare:function(t){var e=0,i=t.getBounds(),r=this.getElements();for(var n in r){var s=r[n];i.contains(s._latlng)&&e++}return e},getElements:function(){return this.getLayers()},_cellHeightAtY:function(t,e){return Math.abs(e/111319*(1/Math.cos(t*Math.PI/180)))},_createCell:function(t,e){return this._grid.createCell(t,e)},_truncateGrid:function(){this._grid.truncate()},_truncateClusters:function(){this._clusters.truncate()},_cellSize:function(){return this.options.cellSize*Math.pow(2,10-this._mapZoom())},gridExtent:function(){return this.getBounds().pad(this.options.gridBoundsPadding)},gridOrigin:function(){return this.gridExtent().getSouthWest()},_mapZoom:function(){return!!this._map&&this._map.getZoom()},_calculateGridOrigin:function(){}}),L.regularGridCluster=function(t){return new L.RegularGridCluster(t)};