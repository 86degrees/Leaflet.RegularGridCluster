L.RegularGridClusterCell=L.Polygon.extend({options:{weight:1,fillOpacity:.6,clickable:!1,color:"grey",lineJoin:"miter"},initialize:function(t,e){this.options=L.extend(this.options,e),L.Util.setOptions(this,this.options),L.Polygon.prototype.initialize.call(this,t,this.options)}}),L.regularGridClusterCell=function(t,e){return new L.RegularGridClusterCell(t,e)},L.RegularGridClusterClusterGroup=L.FeatureGroup.extend({options:{},initialize:function(t){this.controller=t.controller,this.options=L.extend(this.options,t),L.Util.setOptions(this,t),L.FeatureGroup.prototype.initialize.call(this,{features:[]},t)},addLayer:function(t){L.FeatureGroup.prototype.addLayer.call(this,t)},truncate:function(){this.clearLayers()}}),L.regularGridClusterClusterGroup=function(t){return new L.RegularGridClusterClusterGroup(t)},L.RegularGridClusterClusterMarker=L.Marker.extend({options:{},initialize:function(t){this.options=L.extend(this.options,t),L.Util.setOptions(this,t),L.Marker.prototype.initialize.call(this,{features:[]},t)}}),L.regularGridClusterClusterMarker=function(t){return new L.RegularGridClusterClusterMarker(t)},L.RegularGridClusterGrid=L.FeatureGroup.extend({options:{},initialize:function(t){this.controller=t.controller,this.cellid=0,this.options=L.extend(this.options,t),this.cells=[],L.Util.setOptions(this,t),L.FeatureGroup.prototype.initialize.call(this,{features:[]},t)},render:function(t,e){this.visualiseCells(),console.log(t),console.log(e)},createCell:function(t,e){var i=new L.regularGridClusterCell(t,e);return i.cellId=this.cellid,this.addLayer(i),this.cellid++,i},addValueToCell:function(t,e,i){t.options[e]=i},visualiseCells:function(){var t=this.getCells(),e=this.maxInside(t)+1,i=this.options.fillScale.length,r=e/i;for(var l in t){var n=t[l],s=this.options.fillScale[Math.floor(n.inside/r)];n.setStyle({fillColor:s})}},maxInside:function(t){return Math.max.apply(Math,t.map(function(t){return t.inside}))},getCells:function(){return this.getLayers()},truncate:function(){this.clearLayers()}}),L.regularGridClusterGrid=function(t){return new L.RegularGridClusterGrid(t)},L.RegularGridCluster=L.GeoJSON.extend({options:{gridBoundsPadding:.1,gridMode:"square",cellSize:1e4,rules:{},gridFillColor:"white",gridFillOpacity:.05,gridStrokeColor:"grey",gridStrokeWeight:2,gridStrokeOpacity:.4},initialize:function(t){this.options=L.extend(this.options,t),this.lastelmid=0,L.Util.setOptions(this,t),this._elements={},this._cells=[],this._grid=new L.regularGridClusterGrid({controller:this}),this._clusters=new L.regularGridClusterClusterGroup({controller:this}),L.FeatureGroup.prototype.initialize.call(this,{features:[]},t)},onAdd:function(t){var e=this;this._map=t,this._grid.addTo(this._map),this._clusters.addTo(this._map),this._map.on("zoomend",function(){e.refresh(!0,!0)}),this.refresh(!0,!0)},addElement:function(t){this._elements[this.lastelmid]={id:this.lastelmid,geometry:t.geometry.coordinates,properties:t.properties},this.lastelmid++,this._map&&this.refresh(!0,!0)},addData:function(t){},refresh:function(t,e){console.log("refresh"),this._prepareCells(),t&&this._buildGrid(),e&&this._buildClusters()},_visualiseCells:function(){var t=this;Object.keys(this.options.rules.grid).map(function(e){var i=t.options.rules.grid[e];if(t._isDynamicalRule(i)){console.log(i),t._cellsValues(i.method,i.attribute);var r=Math.max.apply(null,t._cells.map(function(t){return t.value?t.value:0})),l=Math.min.apply(null,t._cells.map(function(t){return t.value?t.value:9999999999})),n=i.style.length,s=r-l;for(var o in t._cells){var a=t._cells[o],u=t._cells[o].value,h=t._getCellInterval(u,l,r,s,n,i.scale);a.options[e]=i.style[h]}console.log(t._cells)}else for(var c in t._cells)t._cells[c].options[e]=i})},_getCellInterval:function(t,e,i,r,l,n){switch(n){case"size":return t==i?l-1:Math.floor((t-e)/r*l);default:return t==i?l-1:Math.floor((t-e)/r*l)}},_cellsValues:function(t,e){for(var i in this._cells){var r,l=this._cells[i];switch(t){case"count":l.value=l.elms.length;break;case"mean":r=this._cellAttrValues(l,e),l.value=this._math_mean(r);break;case"median":r=this._cellAttrValues(l,e),l.value=this._math_median(r);break;case"mode":r=this._cellAttrValues(l,e),l.value=this._math_mode(r);break;case"max":r=this._cellAttrValues(l,e),l.value=this._math_max(r);break;case"min":r=this._cellAttrValues(l,e),l.value=this._math_min(r);break;case"sum":r=this._cellAttrValues(l,e),l.value=this._math_sum(r)}}},_cellAttrValues:function(t,e){var i=[];for(var r in t.elms)i.push(this._elements[t.elms[r]].properties[e]);return i},_isDynamicalRule:function(t){return t.method&&t.scale&&t.style},_buildGrid:function(){this._truncateGrid(),this._visualiseCells();for(var t in this._cells){var e=this._cells[t],i=new L.regularGridClusterCell(e.path,e.options);e.value&&this._grid.addLayer(i)}this._grid.addTo(this._map)},_truncateGrid:function(){this._grid.truncate()},_buildClusters:function(){this._truncateClusters()},_prepareCells:function(){this._cells=[];for(var t=1,e=this._cellSize(),i=this._gridOrigin(),r=this._gridExtent().getNorthEast(),l=r.lng,n=r.lat,s=i.lng,o=i.lat,a=e/111319;o<n;){for(var u=this._cellHeightAtY(o,e);s<l;){var h={id:t,x:s,y:o,h:u,w:a,options:{}};h.path=this._cellPath(h),h.elms=this._cellElmsInside(h),this._cells.push(h),t++,s+=a}s=i.lng,o+=u}console.log("created "+this._cells.length+" cells")},_cellPath:function(t){var e=t;switch(this.options.gridMode){case"square":return[[e.y,e.x],[e.y,e.x+e.w],[e.y+e.h,e.x+e.w],[e.y+e.h,e.x],[e.y,e.x]];default:return[[e.y,e.x],[e.y,e.x+e.w],[e.y+e.h,e.x+e.w],[e.y+e.h,e.x],[e.y,e.x]]}},_cellElmsInside:function(t){switch(this.options.gridMode){case"square":return this._elmsInsideSquare(t);default:return this._elmsInsideSquare(t)}},_elmsInsideSquare:function(t){var e=[],i=new L.latLngBounds(L.latLng(t.y,t.x),L.latLng(t.y+t.h,t.x+t.w)),r=this._getElementsCollection();for(var l in r){var n=r[l];i.contains(n.geometry)&&e.push(n.id)}return e},_getElementsCollection:function(){var t=this;return Object.keys(this._elements).map(function(e){return t._elements[e]})},_createCell:function(t,e){return this._grid.createCell(t,e)},_truncateClusters:function(){this._clusters.truncate()},_cellSize:function(){return this.options.cellSize*Math.pow(2,10-this._mapZoom())},_gridOrigin:function(){return this._gridExtent().getSouthWest()},_gridExtent:function(){return this._getBounds().pad(this.options.gridBoundsPadding)},_getBounds:function(){var t=this._getGeometries();return L.latLngBounds(t)},_getGeometries:function(){var t=[],e=this._getElementsCollection();for(var i in e)t.push(e[i].geometry);return t},_mapZoom:function(){return!!this._map&&this._map.getZoom()},_calculateGridOrigin:function(){},_cellHeightAtY:function(t,e){return e/111319*this._deltaHeightAtY(t)},_deltaHeightAtY:function(t){return Math.abs(1/Math.cos(t*Math.PI/180))},_math_max:function(t){return t.length?Math.max.apply(null,t.map(function(t){return t?t:0})):void 0},_math_min:function(t){return t.length?Math.min.apply(null,t.map(function(t){return t?t:99999})):void 0},_math_mode:function(t){if(0===t.length)return null;for(var e={},i=t[0],r=1,l=0;l<t.length;l++){var n=t[l];n&&(null===e[n]?e[n]=1:e[n]++,e[n]>r&&(i=n,r=e[n]))}return i},_math_mean:function(t){var e=t.reduce(function(t,e){return e&&(t.sum+=e,t.count+=1),t},{sum:0,count:0});return e.sum/e.count},_math_sum:function(t){return 0===t.length?0:t.reduce(function(t,e){return e?t+e:0},0)},_math_median:function(t){t.sort(function(t,e){return t-e});var e=Math.floor(t.length/2);return t.length%2?t[e]:(t[e-1]+t[e])/2}}),L.regularGridCluster=function(t){return new L.RegularGridCluster(t)};